let interval_ms = 60000; // 1 minute
let co2_par_kwh = 0.06;

// Ã‰tat courant
let energie_produite_wh = 0;
let energie_injectee_wh = 0;
let energie_autoconsommee_wh = 0;
let economie_eur = 0;
let co2_kg = 0;

// Zone Tempo par dÃ©faut et topic MQTT
let tempoZone = "Bleu";
let mqttTopic = "tempo/jour_couleur";

// Souscription au topic Tempo
MQTT.subscribe(mqttTopic, function (topic, message) {
  try {
    if (message && ["Bleu", "Blanc", "Rouge"].includes(message)) {
      tempoZone = message;
      print("ğŸ“¡ Zone Tempo reÃ§ue via MQTT :", tempoZone);
    } else {
      print("âš ï¸ Message invalide reÃ§u via MQTT : ", message);
    }
  } catch (error) {
    print("âŒ Erreur MQTT :", error);
  }
});

// Tarifs Tempo
function getTarifTempo(zone) {
  const tarifsTempo = {
    Bleu:  { HP: 0.1552, HC: 0.1288 },
    Blanc: { HP: 0.1792, HC: 0.1447 },
    Rouge: { HP: 0.6586, HC: 0.1518 }
  };

  let now = new Date();
  let heure = now.getHours();
  let isHC = (heure >= 22 || heure < 6);

  return isHC ? tarifsTempo[zone].HC : tarifsTempo[zone].HP;
}

// Calcul des Ã©conomies et CO2
function calculerEconomiesEtCO2(energie) {
  let tarif = getTarifTempo(tempoZone);
  let economie = (energie / 1000) * tarif;
  let co2 = (energie / 1000) * co2_par_kwh;

  print("ğŸ” Calcul Ã©conomie/COâ‚‚ : Energie=", energie.toFixed(2), "Wh | Tarif=", tarif.toFixed(4), "â‚¬/kWh");
  return { economie: economie, co2: co2 };
}

// Timer principal
Timer.set(interval_ms, true, function () {
  let emStatus = Shelly.getComponentStatus("em:0");
  if (!emStatus) {
    print("âŒ em:0 non disponible");
    return;
  }

  let solarPower = emStatus.a_act_power || 0;
  let gridPower = emStatus.c_act_power || 0;

  let energie_interval = solarPower * interval_ms / 1000 / 3600;
  energie_produite_wh += energie_interval;

  if (gridPower < 0) {
    let injectee = Math.abs(gridPower) * interval_ms / 1000 / 3600;
    energie_injectee_wh += injectee;
  } else {
    let auto = energie_interval;
    energie_autoconsommee_wh += auto;

    let resultats = calculerEconomiesEtCO2(auto);
    economie_eur += resultats.economie;
    co2_kg += resultats.co2;
  }

  // Affichage
  print("====== Suivi Ã©nergie (Tempo) ======");
  print("ğŸ“… Zone Tempo :", tempoZone);
  print("â˜€ï¸  Solaire :", solarPower.toFixed(1), "W");
  print("âš¡ï¸ RÃ©seau :", gridPower.toFixed(1), "W");
  print("ğŸ”‹ Produite :", energie_produite_wh.toFixed(2), "Wh");
  print("ğŸ  AutoconsommÃ©e :", energie_autoconsommee_wh.toFixed(2), "Wh");
  print("ğŸ” InjectÃ©e :", energie_injectee_wh.toFixed(2), "Wh");
  print("ğŸ’° Ã‰conomie :", economie_eur.toFixed(3), "â‚¬");
  print("ğŸŒ± COâ‚‚ Ã©vitÃ© :", co2_kg.toFixed(3), "kg");
  print("===================================");
});

// RÃ©initialisation quotidienne
let jourPrecedent = (new Date()).getDate();

Timer.set(3600000, true, function () {  // VÃ©rifie chaque heure
  let now = new Date();
  if (now.getDate() !== jourPrecedent) {
    energie_produite_wh = 0;
    energie_injectee_wh = 0;
    energie_autoconsommee_wh = 0;
    economie_eur = 0;
    co2_kg = 0;
    jourPrecedent = now.getDate();
    print("ğŸ”„ RÃ©initialisation journaliÃ¨re.");
  }
});
